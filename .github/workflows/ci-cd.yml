name: Build and Deploy

permissions:
  contents: write

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build:
    if: ${{ !(startsWith(github.ref, 'refs/tags/v') && github.actor == 'github-actions[bot]') }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Ensure semver tag on main
      id: ensure-semver-tag
      if: github.ref == 'refs/heads/main'
      run: |
        set -eu
        git fetch --tags --force
        SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'
        EXISTING_TAG="$(git tag --points-at HEAD | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"

        if [ -n "${EXISTING_TAG}" ]; then
          echo "tag=${EXISTING_TAG}" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        LAST_TAG="$(git tag -l 'v*' --sort=-v:refname | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"
        if [ -z "${LAST_TAG}" ]; then
          NEXT_TAG="v1.0.0"
        else
          VERSION="${LAST_TAG#v}"
          MAJOR="${VERSION%%.*}"
          REST="${VERSION#*.}"
          MINOR="${REST%%.*}"
          PATCH="${VERSION##*.}"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
        fi

        git tag "${NEXT_TAG}" "${GITHUB_SHA}"
        git push origin "${NEXT_TAG}"
        echo "tag=${NEXT_TAG}" >> "$GITHUB_OUTPUT"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.11.1'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Build application
      run: npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image with Buildx (no push)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: popcorn-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Deploy to production
      run: |
        echo "üöÄ Î∞∞Ìè¨ Îã®Í≥ÑÎ•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî"
        echo "Ïòà: SSHÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ Î∞∞Ìè¨, Kubernetes Î∞∞Ìè¨ Îì±"
        # Ïã§Ï†ú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä

  ecr-push:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v')) && !(startsWith(github.ref, 'refs/tags/v') && github.actor == 'github-actions[bot]')
    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: goorm-popcorn-front
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Compute image tags
      id: image-tags
      run: |
        set -eu
        git fetch --tags --force
        SHA_SHORT="${GITHUB_SHA::8}"
        REF="${GITHUB_REF}"
        REF_NAME="${GITHUB_REF_NAME}"
        REGISTRY="${{ steps.login-ecr.outputs.registry }}"
        REPO="${ECR_REPOSITORY}"
        SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'

        TAGS=""
        if [ "$REF" = "refs/heads/main" ]; then
          HEAD_SEMVER_TAG="$(git tag --points-at HEAD | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"
          if [ -z "${HEAD_SEMVER_TAG}" ]; then
            echo "main Î∏åÎûúÏπòÏóêÏÑú semver ÌÉúÍ∑∏ Ï°∞Ìöå Ïã§Ìå®"
            exit 1
          fi
          TAGS="${REGISTRY}/${REPO}:${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:${HEAD_SEMVER_TAG}"$'\n'"${REGISTRY}/${REPO}:latest"
        elif [ "$REF" = "refs/heads/develop" ]; then
          TAGS="${REGISTRY}/${REPO}:dev-${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:dev-latest"
        elif [[ "$REF" == refs/tags/v* ]]; then
          if ! echo "${REF_NAME}" | grep -Eq "${SEMVER_REGEX}"; then
            echo "Invalid semver tag: ${REF_NAME}"
            exit 1
          fi
          TAGS="${REGISTRY}/${REPO}:${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:${REF_NAME}"$'\n'"${REGISTRY}/${REPO}:latest"
        else
          echo "Unsupported ref: $REF"
          exit 1
        fi

        {
          echo "tags<<EOF"
          echo "$TAGS"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Build and Push Docker image to ECR
      id: ecr-build-push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        platforms: linux/amd64
        tags: ${{ steps.image-tags.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Notify Discord on ECR push success
      if: ${{ success() && env.DISCORD_WEBHOOK_URL != '' }}
      run: |
        set -eu
        SHA_SHORT="${GITHUB_SHA::8}"
        TAGS="${{ steps.image-tags.outputs.tags }}"
        TAGS_ONE_LINE="$(echo "$TAGS" | tr '\n' ',' | sed 's/,$//')"
        MESSAGE=$(cat <<EOF
        {
          "content": "‚úÖ ECR Push Success | Repo: ${GITHUB_REPOSITORY} | Ref: ${GITHUB_REF_NAME} | Commit: ${SHA_SHORT} | Tags: ${TAGS_ONE_LINE}"
        }
        EOF
        )
        curl -sS -X POST \
          -H "Content-Type: application/json" \
          -d "$MESSAGE" \
          "$DISCORD_WEBHOOK_URL"
