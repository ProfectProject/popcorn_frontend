name: Build and Deploy

permissions:
  contents: write

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build:
    if: ${{ !(startsWith(github.ref, 'refs/tags/v') && github.actor == 'github-actions[bot]') }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Ensure semver tag on main
      id: ensure-semver-tag
      if: github.ref == 'refs/heads/main'
      run: |
        set -eu
        git fetch --tags --force
        SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'
        EXISTING_TAG="$(git tag --points-at HEAD | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"

        if [ -n "${EXISTING_TAG}" ]; then
          echo "tag=${EXISTING_TAG}" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        LAST_TAG="$(git tag -l 'v*' --sort=-v:refname | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"
        if [ -z "${LAST_TAG}" ]; then
          NEXT_TAG="v1.0.0"
        else
          VERSION="${LAST_TAG#v}"
          MAJOR="${VERSION%%.*}"
          REST="${VERSION#*.}"
          MINOR="${REST%%.*}"
          PATCH="${VERSION##*.}"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"
        fi

        git tag "${NEXT_TAG}" "${GITHUB_SHA}"
        git push origin "${NEXT_TAG}"
        echo "tag=${NEXT_TAG}" >> "$GITHUB_OUTPUT"

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.11.1'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Build application
      run: npm run build

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Deploy to production
      run: |
        echo "üöÄ Î∞∞Ìè¨ Îã®Í≥ÑÎ•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî"
        echo "Ïòà: SSHÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ Î∞∞Ìè¨, Kubernetes Î∞∞Ìè¨ Îì±"
        # Ïã§Ï†ú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä

  ecr-push:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')) && !(startsWith(github.ref, 'refs/tags/v') && github.actor == 'github-actions[bot]')
    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: goorm-popcorn-front
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Compute image tags
      id: image-tags
      run: |
        set -eu
        git fetch --tags --force
        SHA_SHORT="${GITHUB_SHA::8}"
        REF="${GITHUB_REF}"
        REF_NAME="${GITHUB_REF_NAME}"
        REGISTRY="${{ steps.login-ecr.outputs.registry }}"
        REPO="${ECR_REPOSITORY}"
        SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'

        TAGS=""
        if [ "$REF" = "refs/heads/main" ]; then
          HEAD_SEMVER_TAG="$(git tag --points-at HEAD | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"
          if [ -z "${HEAD_SEMVER_TAG}" ]; then
            echo "main Î∏åÎûúÏπòÏóêÏÑú semver ÌÉúÍ∑∏ Ï°∞Ìöå Ïã§Ìå®"
            exit 1
          fi
          TAGS="${REGISTRY}/${REPO}:${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:${HEAD_SEMVER_TAG}"$'\n'"${REGISTRY}/${REPO}:latest"
        elif [[ "$REF" == refs/tags/v* ]]; then
          if ! echo "${REF_NAME}" | grep -Eq "${SEMVER_REGEX}"; then
            echo "Invalid semver tag: ${REF_NAME}"
            exit 1
          fi
          TAGS="${REGISTRY}/${REPO}:${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:${REF_NAME}"$'\n'"${REGISTRY}/${REPO}:latest"
        else
          echo "Unsupported ref: $REF"
          exit 1
        fi

        {
          echo "tags<<EOF"
          echo "$TAGS"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Build and Push Docker image to ECR
      id: ecr-build-push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        tags: ${{ steps.image-tags.outputs.tags }}
        provenance: false
        sbom: false
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Notify Discord on ECR push success
      if: ${{ success() && env.DISCORD_WEBHOOK_URL != '' }}
      run: |
        set -eu
        TAGS="${{ steps.image-tags.outputs.tags }}"
        IMAGE="$(echo "$TAGS" | head -n 1)"
        AUTHOR="${{ github.actor }}"
        REPO="${GITHUB_REPOSITORY}"
        SERVICE="${ECR_REPOSITORY}"
        RUN_NO="${GITHUB_RUN_NUMBER}"
        COMMIT="${GITHUB_SHA}"
        MESSAGE=$(cat <<EOF
        {
          "content": "‚úÖ Deploy SUCCESS by.${AUTHOR}\n- üë§ Author: ${AUTHOR}\n- Service: ${SERVICE}\n- Repo: ${REPO}\n- Image: ${IMAGE}\n- Run: #${RUN_NO}\n- Commit: ${COMMIT}"
        }
        EOF
        )
        curl -sS -X POST \
          -H "Content-Type: application/json" \
          -d "$MESSAGE" \
          "$DISCORD_WEBHOOK_URL"

  update-gitops-values:
    name: Update GitOps values (frontend)
    needs: [ecr-push]
    if: github.event_name == 'push' && github.ref_name == 'main'
    runs-on: ubuntu-latest

    permissions:
      contents: read

    env:
      GITOPS_REPO: ProfectProject/popcorn_deploy
      GITOPS_BRANCH: main

    steps:
    - name: Checkout source repository (for tag resolution)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Set IMAGE_TAG and VALUES_FILE by branch
      id: gitops_tag
      shell: bash
      run: |
        set -euo pipefail
        if [[ "${GITHUB_REF_NAME}" != "main" ]]; then
          echo "Unsupported branch for GitOps update: ${GITHUB_REF_NAME}"
          exit 1
        fi

        git fetch --tags --force
        SEMVER_REGEX='^v[0-9]+\.[0-9]+\.[0-9]+$'
        RESOLVED_TAG="$(git tag --points-at "${GITHUB_SHA}" | grep -E "${SEMVER_REGEX}" | head -n 1 || true)"
        if [[ -z "${RESOLVED_TAG}" ]]; then
          echo "SemVer tag not found on commit ${GITHUB_SHA}"
          exit 1
        fi

        echo "IMAGE_TAG=${RESOLVED_TAG}" >> "$GITHUB_ENV"
        echo "VALUES_FILE=helm/popcorn-umbrella/values-prod.yaml" >> "$GITHUB_ENV"
        echo "Using IMAGE_TAG=${RESOLVED_TAG}"
        echo "Using VALUES_FILE=helm/popcorn-umbrella/values-prod.yaml"

    - name: Install tools (jq, yq)
      shell: bash
      run: |
        set -euo pipefail
        sudo apt-get update -y
        sudo apt-get install -y jq
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq
        yq --version
        jq --version

    - name: Clone GitOps repo
      shell: bash
      env:
        GITOPS_TOKEN: ${{ secrets.GITOPS_TOKEN }}
      run: |
        set -euo pipefail
        git clone "https://x-access-token:${GITOPS_TOKEN}@github.com/${GITOPS_REPO}.git" gitops
        cd gitops
        git checkout "${GITOPS_BRANCH}"

    - name: Update GitOps values for frontend only
      shell: bash
      run: |
        set -euo pipefail
        cd gitops

        # ÌîÑÎ°†Ìä∏ ÏÑúÎπÑÏä§ ÌÇ§ ÏûêÎèô ÌÉêÏÉâ: frontend -> front -> web
        SERVICE_KEY=""
        for key in frontend front web; do
          if [[ "$(yq e "has(\"${key}\")" "${VALUES_FILE}")" == "true" ]]; then
            SERVICE_KEY="${key}"
            break
          fi
        done

        if [[ -z "${SERVICE_KEY}" ]]; then
          echo "No frontend key found in ${VALUES_FILE}. Tried: frontend, front, web"
          exit 1
        fi

        echo "Updating .${SERVICE_KEY}.image.tag -> ${IMAGE_TAG}"
        yq -i ".${SERVICE_KEY}.image.tag = \"${IMAGE_TAG}\"" "${VALUES_FILE}"

        echo "---- diff ----"
        git diff -- "${VALUES_FILE}" || true

    - name: Commit & push (single commit)
      shell: bash
      run: |
        set -euo pipefail
        cd gitops

        if git diff --quiet; then
          echo "No changes to commit."
          exit 0
        fi

        git config user.name "github-actions"
        git config user.email "actions@github.com"

        git add "${VALUES_FILE}"
        git commit -m "chore(gitops): bump frontend image tag -> ${IMAGE_TAG}"
        git push origin "${GITOPS_BRANCH}"
