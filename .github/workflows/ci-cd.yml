name: Build and Deploy

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.11.1'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint

    - name: Build application
      run: npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image with Buildx (no push)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: popcorn-frontend:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Deploy to production
      run: |
        echo "üöÄ Î∞∞Ìè¨ Îã®Í≥ÑÎ•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî"
        echo "Ïòà: SSHÎ•º ÌÜµÌïú ÏÑúÎ≤Ñ Î∞∞Ìè¨, Kubernetes Î∞∞Ìè¨ Îì±"
        # Ïã§Ï†ú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏Î•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä

  ecr-push:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    env:
      AWS_REGION: ap-northeast-2
      ECR_REPOSITORY: goorm-popcorn-front

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Compute image tags
      id: image-tags
      run: |
        set -eu
        SHA_SHORT="${GITHUB_SHA::8}"
        REF="${GITHUB_REF}"
        REF_NAME="${GITHUB_REF_NAME}"
        REGISTRY="${{ steps.login-ecr.outputs.registry }}"
        REPO="${ECR_REPOSITORY}"

        TAGS=""
        if [ "$REF" = "refs/heads/main" ]; then
          TAGS="${REGISTRY}/${REPO}:${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:latest"
        elif [ "$REF" = "refs/heads/develop" ]; then
          TAGS="${REGISTRY}/${REPO}:dev-${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:dev-latest"
        elif [[ "$REF" == refs/tags/v* ]]; then
          TAGS="${REGISTRY}/${REPO}:${SHA_SHORT}"$'\n'"${REGISTRY}/${REPO}:${REF_NAME}"$'\n'"${REGISTRY}/${REPO}:latest"
        else
          echo "Unsupported ref: $REF"
          exit 1
        fi

        {
          echo "tags<<EOF"
          echo "$TAGS"
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Build and Push Docker image to ECR
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: true
        platforms: linux/amd64
        tags: ${{ steps.image-tags.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
